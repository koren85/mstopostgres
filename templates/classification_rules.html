{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Правила классификации данных</h2>
    
    <style>
        /* Стили для таблицы правил */
        #rulesTable {
            table-layout: fixed;
            width: 100%;
        }
        
        #rulesTable th, #rulesTable td {
            vertical-align: middle;
        }
        
        /* Задаем ширину для каждой колонки */
        #rulesTable th:nth-child(1), #rulesTable td:nth-child(1) { width: 3%; } /* ID */
        #rulesTable th:nth-child(2), #rulesTable td:nth-child(2) { width: 5%; } /* Приоритет */
        #rulesTable th:nth-child(3), #rulesTable td:nth-child(3) { width: 10%; } /* Категория */
        #rulesTable th:nth-child(4), #rulesTable td:nth-child(4) { width: 10%; } /* Действие */
        #rulesTable th:nth-child(5), #rulesTable td:nth-child(5) { width: 10%; } /* Тип условия */
        #rulesTable th:nth-child(6), #rulesTable td:nth-child(6) { width: 10%; } /* Поле условия */
        #rulesTable th:nth-child(7), #rulesTable td:nth-child(7) { width: 15%; } /* Шаблон */
        #rulesTable th:nth-child(8), #rulesTable td:nth-child(8) { width: 10%; } /* Порог уверенности */
        #rulesTable th:nth-child(9), #rulesTable td:nth-child(9) { width: 17%; } /* Комментарий */
        #rulesTable th:nth-child(10), #rulesTable td:nth-child(10) { width: 10%; } /* Действия */
        
        /* Добавляем перенос текста для ячеек */
        #rulesTable td {
            word-wrap: break-word;
            white-space: normal;
        }
        
        /* Специальные стили для колонки "Шаблон" */
        #rulesTable td:nth-child(7) {
            max-width: 150px;
            overflow-wrap: break-word;
        }
        
        /* Стили для комментария */
        #rulesTable td:nth-child(9) {
            max-width: 170px;
            overflow-wrap: break-word;
        }
    </style>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Список правил классификации</h5>
            <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addRuleModal">
                <i class="bi bi-plus-circle"></i> Добавить правило
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="rulesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Приоритет</th>
                            <th>Категория</th>
                            <th>Действие</th>
                            <th>Тип условия</th>
                            <th>Поле условия</th>
                            <th>Шаблон</th>
                            <th>Порог уверенности</th>
                            <th>Комментарий</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rule in rules %}
                        <tr>
                            <td>{{ rule.id }}</td>
                            <td>{{ rule.priority }}</td>
                            <td>{{ rule.category_name }}</td>
                            <td>
                                <span class="badge {% if rule.priznak_value == 'Переносим' %}bg-success{% elif rule.priznak_value == 'Переносим пакетом' %}bg-info{% elif rule.priznak_value == 'Не переносим' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ rule.priznak_value }}
                                </span>
                            </td>
                            <td>{{ rule.condition_type }}</td>
                            <td>{{ rule.condition_field }}</td>
                            <td>{{ rule.condition_value }}</td>
                            <td>{{ rule.confidence_threshold }}</td>
                            <td>{{ rule.comment }}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary edit-rule" 
                                            data-rule-id="{{ rule.id }}"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editRuleModal">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-rule" 
                                            data-rule-id="{{ rule.id }}"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#deleteRuleModal">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if total_pages > 1 %}
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('classification_rules', page=1) }}" aria-label="Первая">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('classification_rules', page=page-1) }}" aria-label="Предыдущая">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    
                    {% set start_page = [1, page - 2]|max %}
                    {% set end_page = [total_pages, page + 2]|min %}
                    
                    {% if start_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('classification_rules', page=1) }}">1</a>
                        </li>
                        {% if start_page > 2 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endif %}
                    
                    {% for p in range(start_page, end_page + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('classification_rules', page=p) }}">{{ p }}</a>
                        </li>
                    {% endfor %}
                    
                    {% if end_page < total_pages %}
                        {% if end_page < total_pages - 1 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('classification_rules', page=total_pages) }}">{{ total_pages }}</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('classification_rules', page=page+1) }}" aria-label="Следующая">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    
                    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('classification_rules', page=total_pages) }}" aria-label="Последняя">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно добавления правила -->
<div class="modal fade" id="addRuleModal" tabindex="-1" aria-labelledby="addRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRuleModalLabel">Добавить новое правило классификации</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRuleForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="priority" class="form-label">Приоритет</label>
                            <input type="number" class="form-control" id="priority" name="priority" required>
                        </div>
                        <div class="col-md-6">
                            <label for="category_name" class="form-label">Категория</label>
                            <input type="text" class="form-control" id="category_name" name="category_name" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transfer_action" class="form-label">Действие</label>
                        <select class="form-select" id="transfer_action" name="transfer_action" required>
                            <option value="">Выберите действие</option>
                            <option value="Переносим">Переносим</option>
                            <option value="Переносим пакетом">Переносим пакетом</option>
                            <option value="Не переносим">Не переносим</option>
                            <option value="Нет данных">Нет данных</option>
                        </select>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="condition_type" class="form-label">Тип условия</label>
                            <select class="form-select" id="condition_type" name="condition_type" required>
                                <option value="">Выберите тип условия</option>
                                <option value="EXACT_EQUALS">Точное совпадение</option>
                                <option value="STARTS_WITH">Начинается с</option>
                                <option value="CONTAINS">Содержит</option>
                                <option value="IS_EMPTY">Пусто</option>
                                <option value="ALWAYS_TRUE">Всегда истинно</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="condition_field" class="form-label">Поле условия</label>
                            <select class="form-select" id="condition_field" name="condition_field" required>
                                <option value="">Выберите поле</option>
                                <option value="name">Имя класса (mssql_sxclass_name)</option>
                                <option value="description">Описание (mssql_sxclass_description)</option>
                                <option value="MSSQL_SXCLASS_NAME">MSSQL_SXCLASS_NAME</option>
                                <option value="MSSQL_SXCLASS_DESCRIPTION">MSSQL_SXCLASS_DESCRIPTION</option>
                                <option value="MSSQL_SXCLASS_MAP">MSSQL_SXCLASS_MAP</option>
                                <option value="Родительский класс">Родительский класс</option>
                                <option value="Создал">Создал</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="condition_value" class="form-label">Шаблон</label>
                        <input type="text" class="form-control" id="condition_value" name="condition_value" required>
                        <small class="form-text text-muted">Строка для поиска в выбранном поле</small>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="confidence_threshold" class="form-label">Порог уверенности</label>
                            <input type="number" class="form-control" id="confidence_threshold" name="confidence_threshold" value="0.8" min="0" max="1" step="0.1">
                            <small class="form-text text-muted">Значение от 0 до 1, по умолчанию 0.8</small>
                        </div>
                        <div class="col-md-6">
                            <label for="comment" class="form-label">Комментарий</label>
                            <textarea class="form-control" id="comment" name="comment" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <input type="hidden" id="priznak_value" name="priznak_value">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveNewRule">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования правила -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-labelledby="editRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRuleModalLabel">Редактировать правило классификации</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRuleForm">
                    <input type="hidden" id="edit_rule_id" name="rule_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_priority" class="form-label">Приоритет</label>
                            <input type="number" class="form-control" id="edit_priority" name="priority" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_category_name" class="form-label">Категория</label>
                            <input type="text" class="form-control" id="edit_category_name" name="category_name" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_transfer_action" class="form-label">Действие</label>
                        <select class="form-select" id="edit_transfer_action" name="transfer_action" required>
                            <option value="">Выберите действие</option>
                            <option value="Переносим">Переносим</option>
                            <option value="Переносим пакетом">Переносим пакетом</option>
                            <option value="Не переносим">Не переносим</option>
                            <option value="Нет данных">Нет данных</option>
                        </select>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_condition_type" class="form-label">Тип условия</label>
                            <select class="form-select" id="edit_condition_type" name="condition_type" required>
                                <option value="">Выберите тип условия</option>
                                <option value="EXACT_EQUALS">Точное совпадение</option>
                                <option value="STARTS_WITH">Начинается с</option>
                                <option value="CONTAINS">Содержит</option>
                                <option value="IS_EMPTY">Пусто</option>
                                <option value="ALWAYS_TRUE">Всегда истинно</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_condition_field" class="form-label">Поле условия</label>
                            <select class="form-select" id="edit_condition_field" name="condition_field" required>
                                <option value="">Выберите поле</option>
                                <option value="name">Имя класса (mssql_sxclass_name)</option>
                                <option value="description">Описание (mssql_sxclass_description)</option>
                                <option value="MSSQL_SXCLASS_NAME">MSSQL_SXCLASS_NAME</option>
                                <option value="MSSQL_SXCLASS_DESCRIPTION">MSSQL_SXCLASS_DESCRIPTION</option>
                                <option value="MSSQL_SXCLASS_MAP">MSSQL_SXCLASS_MAP</option>
                                <option value="Родительский класс">Родительский класс</option>
                                <option value="Создал">Создал</option>
                                <option value="-">-</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_condition_value" class="form-label">Шаблон</label>
                        <input type="text" class="form-control" id="edit_condition_value" name="condition_value" required>
                        <small class="form-text text-muted">Строка для поиска в выбранном поле</small>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_confidence_threshold" class="form-label">Порог уверенности</label>
                            <input type="number" class="form-control" id="edit_confidence_threshold" name="confidence_threshold" min="0" max="1" step="0.1">
                            <small class="form-text text-muted">Значение от 0 до 1, по умолчанию 0.8</small>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_comment" class="form-label">Комментарий</label>
                            <textarea class="form-control" id="edit_comment" name="comment" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <input type="hidden" id="edit_priznak_value" name="priznak_value">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="updateRule">Сохранить изменения</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteRuleModal" tabindex="-1" aria-labelledby="deleteRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRuleModalLabel">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить это правило? Это действие нельзя отменить.</p>
                <input type="hidden" id="delete_rule_id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteRule">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для управления видимостью поля "Шаблон" в зависимости от типа условия
    function togglePatternField(conditionTypeSelect, patternField, patternContainer) {
        if (conditionTypeSelect.value === 'IS_EMPTY' || conditionTypeSelect.value === 'ALWAYS_TRUE') {
            patternContainer.style.display = 'none';
            patternField.value = '-';  // Устанавливаем значение по умолчанию
        } else {
            patternContainer.style.display = 'block';
            if (patternField.value === '-') {
                patternField.value = '';  // Очищаем значение, если оно было установлено по умолчанию
            }
        }
    }
    
    // Функция для синхронизации значения признака с действием
    function syncPriznakValue(actionSelect, priznakValueField) {
        priznakValueField.value = actionSelect.value;
    }
    
    // Обработчики для формы добавления
    const addConditionTypeSelect = document.getElementById('condition_type');
    const addPatternField = document.getElementById('condition_value');
    const addPatternContainer = addPatternField.closest('.mb-3');
    const addTransferAction = document.getElementById('transfer_action');
    const addPriznakValue = document.getElementById('priznak_value');
    
    addConditionTypeSelect.addEventListener('change', function() {
        togglePatternField(this, addPatternField, addPatternContainer);
    });
    
    addTransferAction.addEventListener('change', function() {
        syncPriznakValue(this, addPriznakValue);
    });
    
    // Обработчики для формы редактирования
    const editConditionTypeSelect = document.getElementById('edit_condition_type');
    const editPatternField = document.getElementById('edit_condition_value');
    const editPatternContainer = editPatternField.closest('.mb-3');
    const editTransferAction = document.getElementById('edit_transfer_action');
    const editPriznakValue = document.getElementById('edit_priznak_value');
    
    editConditionTypeSelect.addEventListener('change', function() {
        togglePatternField(this, editPatternField, editPatternContainer);
    });
    
    editTransferAction.addEventListener('change', function() {
        syncPriznakValue(this, editPriznakValue);
    });
    
    // Инициализация при открытии модальных окон
    document.getElementById('addRuleModal').addEventListener('shown.bs.modal', function() {
        togglePatternField(addConditionTypeSelect, addPatternField, addPatternContainer);
        syncPriznakValue(addTransferAction, addPriznakValue);
    });
    
    document.getElementById('editRuleModal').addEventListener('shown.bs.modal', function() {
        togglePatternField(editConditionTypeSelect, editPatternField, editPatternContainer);
        syncPriznakValue(editTransferAction, editPriznakValue);
    });
    
    // Добавление нового правила
    document.getElementById('saveNewRule').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('addRuleForm'));
        const data = Object.fromEntries(formData.entries());
        
        // Устанавливаем значение признака равным значению действия
        data.priznak_value = data.transfer_action;
        
        // Преобразуем числовые значения
        if (data.priority) data.priority = parseInt(data.priority);
        if (data.confidence_threshold) data.confidence_threshold = parseFloat(data.confidence_threshold);
        
        // Добавляем source_batch_id если его нет
        if (!data.source_batch_id) data.source_batch_id = '1';
        
        // Для совместимости с API
        data.field = data.condition_field;
        data.pattern = data.condition_value;
        
        console.log('Отправляемые данные:', data);
        
        fetch('/api/classification_rules', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно и перезагружаем страницу
                const modal = bootstrap.Modal.getInstance(document.getElementById('addRuleModal'));
                modal.hide();
                window.location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при сохранении правила');
        });
    });
    
    // Загрузка данных для редактирования
    document.querySelectorAll('.edit-rule').forEach(button => {
        button.addEventListener('click', function() {
            const ruleId = this.getAttribute('data-rule-id');
            
            fetch(`/api/classification_rules/${ruleId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const rule = data.rule;
                    document.getElementById('edit_rule_id').value = rule.id;
                    document.getElementById('edit_priority').value = rule.priority;
                    document.getElementById('edit_category_name').value = rule.category_name;
                    document.getElementById('edit_transfer_action').value = rule.transfer_action;
                    document.getElementById('edit_priznak_value').value = rule.priznak_value;
                    document.getElementById('edit_condition_type').value = rule.condition_type;
                    document.getElementById('edit_condition_field').value = rule.condition_field;
                    document.getElementById('edit_condition_value').value = rule.condition_value;
                    document.getElementById('edit_confidence_threshold').value = rule.confidence_threshold;
                    document.getElementById('edit_comment').value = rule.comment;
                } else {
                    alert('Ошибка: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при загрузке данных правила');
            });
        });
    });
    
    // Обновление правила
    document.getElementById('updateRule').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('editRuleForm'));
        const data = Object.fromEntries(formData.entries());
        const ruleId = data.rule_id;
        
        // Устанавливаем значение признака равным значению действия
        data.priznak_value = data.transfer_action;
        
        // Преобразуем числовые значения
        if (data.priority) data.priority = parseInt(data.priority);
        if (data.confidence_threshold) data.confidence_threshold = parseFloat(data.confidence_threshold);
        
        // Для совместимости с API
        data.field = data.condition_field;
        data.pattern = data.condition_value;
        
        console.log('Отправляемые данные для обновления:', data);
        
        fetch(`/api/classification_rules/${ruleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно и перезагружаем страницу
                const modal = bootstrap.Modal.getInstance(document.getElementById('editRuleModal'));
                modal.hide();
                window.location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при обновлении правила');
        });
    });
    
    // Подготовка к удалению
    document.querySelectorAll('.delete-rule').forEach(button => {
        button.addEventListener('click', function() {
            const ruleId = this.getAttribute('data-rule-id');
            document.getElementById('delete_rule_id').value = ruleId;
        });
    });
    
    // Удаление правила
    document.getElementById('confirmDeleteRule').addEventListener('click', function() {
        const ruleId = document.getElementById('delete_rule_id').value;
        
        fetch(`/api/classification_rules/${ruleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно и перезагружаем страницу
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRuleModal'));
                modal.hide();
                window.location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при удалении правила');
        });
    });
});
</script>
{% endblock %} 